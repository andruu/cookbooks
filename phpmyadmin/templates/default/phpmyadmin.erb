# Autogenerated by Chef for <%= @node[:fqdn] %>

server {
  listen       80;
  server_name  <%= @node[:pma][:phpmyadmin_hostname] %> www.<%= @node[:pma][:phpmyadmin_hostname] %>;
  root         <%= @node[:server][:production][:dir] %>/phpmyadmin/public;
  index        index.php;
  error_page   500 501 502 503 504  /error_500.html;
  charset      utf-8;

  server_tokens off;
  server_name_in_redirect off;

  access_log   <%= @node[:nginx][:log_dir] %>/<%= @node[:pma][:phpmyadmin_hostname] %>-access.log sg;
  error_log    <%= @node[:nginx][:log_dir] %>/<%= @node[:pma][:phpmyadmin_hostname] %>-error.log;

  # remove www from the url
  if ($host ~* www\.(.*)) {
    set $host_without_www $1;
    rewrite ^(.*)$ http://$host_without_www$1 permanent;
  }

  location / {
    # If the file exists as a static file serve it directly without
    # running all the other rewite tests on it
    if (-f $request_filename) {
      expires modified +720h;
      break;
    }

    # Set appropriate path
    set $actual_path '';

    # Rewrite non static files directly into index.php
    if ($request_filename !~ "\.(js|htc|ico|gif|jpg|png|css)$") {
      rewrite ^(.*) $actual_path/index.php last;
    }
  }

  location ~ \.php($|/) {
    set  $script     $uri;
    set  $path_info  "";

    if ($uri ~ "^(.+\.php)(/.+)") {
      set  $script     $1;
      set  $path_info  $2;
    }

    include        /etc/nginx/fastcgi_params;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_param  SCRIPT_FILENAME  $document_root$script;
    fastcgi_param  SCRIPT_NAME      $script;
    fastcgi_param  PATH_INFO        $path_info;
  }
}
